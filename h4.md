# h4 Demoni
Sisällysluettelo:

- x)[ Lue ja tiivistä ](#x-lue-ja-tiivistä)
- a)[ Hello SLS! ](#a-hello-sls)
- b)[ Top ](#b-top)
- c)[ Apache easy mode + e) Vapaaehtoinen: Apache](#c-apache-easy-mode-ja-e-vapaaehtoinen-apache)
- d)[ SSHouto ](#d-sshouto)
- e)[ Vapaaehtoinen: Apache](#e-vapaaehtoinen-apache)
- f)[ Vapaaehtoinen: Caddy](#f-vapaaehtoinen-caddy)
- g)[ Vapaaehtoinen: Nginx](#g-vapaaehtoinen-nginx)
- [Lähteet](#lähteet)


Tehtävänanto: [Infra as Code - Palvelinten hallinta 2024.](https://terokarvinen.com/2024/configuration-management-2024-spring/)

___

## x) Lue ja tiivistä
> (Tässä x-alakohdassa ei tarvitse tehdä testejä tietokoneella, vain lukeminen tai kuunteleminen ja tiivistelmä riittää. Tiivistämiseen riittää muutama ranskalainen viiva. Kannattaa lisätä mukaan myös jokin oma havainto, idea tai kysymys.)


### Karvinen 2023: [Salt Vagrant - automatically provision one master and two slaves](https://terokarvinen.com/2023/salt-vagrant/#infra-as-code---your-wishes-as-a-text-file)
#### Infra as Code - Your wishes as a text file
- `/srv/salt/`-kaikille minioneille jaettava kansio, jonne moduulit tehdään
- `sudoedit /srv/salt/hello/init.sls` - luodaan hello-moduuliin `init.sls`-tiedosto, jonne käskyt kirjoitetaan
    - HUOM! Syntaksi on YAML, joten EI TAB:ia! 2x space sen sijaan
    - sisältö:
        - ```
              /tmp/infra-as-code:
                file.managed
        - luo `tmp`-kansioon uuden tiedoston `infra-as-code` 

#### top.sls - What Slave Runs What States
- `top`-tiedosto määrittää mitkä moduulit tietyt minionit ajavat
- `sudoedit /srv/salt/top.sls` - top-tiedoston luominen
    - sisältö: 
        - ```
            base:
              '*':
                - hello
        - `'*'` = kaikki minionit
- `sudo salt '*' state.apply` - nyt hello-moduulia ei tarvitse enää nimetä komennossa 

### Salt contributors: [Salt overview](https://docs.saltproject.io/salt/user-guide/en/latest/topics/overview.html#rules-of-yaml)

#### Rules of YAML
- Data on `key: value`-pareissa (`:`- merkkaa paria)
- Isoilla ja pienillä kirjaimilla on väliä (case-sensitive)
- Tab ei ole sallittu, vain välilyönti
- Kommentointi alkaa `#`llä

#### YAML simple structure
1. Scalars - `key-value`-pari
    -  value = number, string or boolean
2. Lists - `key:` jota seuraa lista arvoja omilla riveillään (rivi alkaa 2x space + `-`)
3. Dictionaries - kokoelma `key: value`-pareja ja listoja

#### Lists and dictionaries - YAML block structures
- Properties ja listat täytyy sisentää!

### Karvinen 2018: [Pkg-File-Service – Control Daemons with Salt – Change SSH Server Port](https://terokarvinen.com/2018/04/03/pkg-file-service-control-daemons-with-salt-change-ssh-server-port/?fromSearch=karvinen%20salt%20ssh)
> Artikkelissa on jonkun toisen Linux-version tiedosto. Jos tekisit samanlaisen, niin käyttäisit tietysti oman järjestelmäsi asetustiedostoa pohjana.

- SSH-portin muuttaminen .sls-tiedoston kautta
- `/srv/salt/sshd.sls`
  - ```
        openssh-server:
            pkg.installed
        /etc/ssh/sshd_config:
            file.managed:
                - source: salt://sshd_config
        sshd:
            service.running:
                - watch:
                    - file: /etc/ssh/sshd_config
- asentaa openssh-serverin, muokkaa sshd_config-tiedoston /srv/salt/-kansiossa olevan configtiedoston mukaiseksi, ja potkii sshd:n uudelleenkäynnistämään jos config on muuttunut 
- alkuperäinen sshd_config löytyy `/etc/ssh/sshd_config` (voi kopioida `/srv/salt/`-kansioon ja tehdä halutut muokkaukset)
- `sudo salt '*' state.apply sshd` - ajaa komennon minioneilla


### Silmäile Saltin ohjeet tilafunktioille pkg, file ja service. 
> Nämä artikkelit ovat pitkiä, riittää kun luet vain johdannon ja silmäilet maintut komennot. Ei kannata yrittää opetella satoja itselle tarpeettomia parametreja ulkoa. (Less-vinkit alla)
> - $ sudo salt-call --local sys.state_doc pkg # johdanto + silmäile pkg.installed, pkg.purged, pkgs
> - $ sudo salt-call --local sys.state_doc file # johdanto + silmäile file.managed, file.absent, file.symlink
> - $ sudo salt-call --local sys.state_doc service # johdanto + silmäile service.running, service.dead, enable

<br>

- pkg.installed - varmistaa että paketti on asennettu
- pkg.purged - varmistaa että paketti on poistettu, kutsuu tarvittaessa pkg.purge paketin poistamiseksi
- pkgs - lista asennettavista paketeista

<br>

- file.managed - hallitse tiedostoa, se voidaan ladata salt-masterilta minioneille
- file.absent - varmistaa että tiedosto ei ole olemassa, jos on niin poistaa sen
- file.symlink - luo symbolinen linkki

<br>

- service.running - varmista että service on päällä
- service.dead - varmista että service on pois päältä, sammuta jos on päällä
- service.enabled - varmistaa että service käynnistyy koneen käynnistyessä
____
## a) Hello SLS!
> Tee Hei maailma -tila kirjoittamalla se tekstitiedostoon, esim /srv/salt/hello/init.sls.

- `sudo mkdir /srv/salt/hello` - luo `/srv/salt/`-kansioon uuden hello-kansion
- `sudoedit /srv/salt/hello/init.sls` - luo init-tiedoston
- sisältö:
    - luo uuden tiedoston /tmp/-kansioon ja lisää siihen tekstin 'Hello World'
<img src='https://github.com/iines-j/palvelin-kurssi/assets/148907657/d7dc0ad5-fd8d-4cbf-86c7-53b54709e907' width=600>

- ajoin komennon paikallisesti `sudo salt-call --local state.apply hello`
<img src='https://github.com/iines-j/palvelin-kurssi/assets/148907657/67471d8d-7918-48df-9ef6-f925d39df67c' width=600>



## b) Top
> Tee top.sls niin, että useita valitsemiasi tiloja ajetaan automaattisesti, esim komennolla "sudo salt '*' state.apply" tai "sudo salt-call --local state.apply".

- `sudoedit /srv/salt/top.sls` - luo top.sls-tiedoston
- `sudo salt '*' state.apply` - ajaa komennon kaikilla minioneilla

<img src='https://github.com/iines-j/palvelin-kurssi/assets/148907657/2f8f1f9d-e4ff-47d2-9799-b1ba5dd8324b' width=600>


## c) Apache easy mode ja e) Vapaaehtoinen: Apache
> Asenna Apache, korvaa sen testisivu ja varmista, että demoni käynnistyy.
> Ensin käsin, vasta sitten automaattisesti.
> Kirjoita tila sls-tiedostoon.

Asensin Apachen käsin oppitunnin aikana, alla olevassa kuvakaappauksessa on antamani komennot sekä conf-tiedoston sisältö. 
<img src='https://github.com/iines-j/palvelin-kurssi/assets/148907657/62d2892e-cfdc-402b-88e9-9df90bdf6a60' width=600>

Loin uuden moduulin `/srv/salt/apa` ja sinne testi.conf- ja init.sls-tiedoston. 
```
# testi.conf
<VirtualHost *:80>
        DocumentRoot /home/vagrant/web/testi
        <Directory /home/vagrant/web/testi>
                Require all granted
        </Directory>
</VirtualHost>

```
```yaml
# asentaa apachen
apache2:
  pkg.installed

# luo uudet kansiot /web/testi ja antaa vagrant-käyttäjälle niihin oikeudet
clean_dir:
  file.directory:
    - name: /home/vagrant/web/testi
    - user: vagrant
    - makedirs: True
    - recurse:
      - user
    - clean: True
    - require:
      - file: testi

# luo index.html-tiedoston ja sen sisällön, antaa oikeudet vagrant-käyttäjälle
testi:
  file.managed:
    - name: /home/vagrant/web/testi/index.html
    - user: vagrant
    - contents: hei testisivu

# kopioi conf-tiedoston moduulin kansiosta
/etc/apache2/sites-available/testi.conf:
  file.managed:
    - source: "salt://apa/testi.conf"
    - watch_in:
      - service: "apache2.service"

# poistaa 000-default.conf-tiedoston
/etc/apache2/sites-enabled/000-default.conf:
  file.absent

# luo symlinkin /sites-available/-kansiossa olevaan conffiin
/etc/apache2/sites-enabled/testi.conf:
  file.symlink:
    - target: "/etc/apache2/sites-available/testi.conf"
    - watch_in:
      - service: "apache2.service"

# ^ watch_in-kohdat ylemmissä potkii apachen uudelleenkäynnistymään jos ne muuttuvat
apache2.service:
  service.running
```

Jouduin hieman hiomaan init-tiedostoa, että sain uudet kansiot ja index.html-tiedoston muokattavaksi ilman sudoa. Saltin manuaalin [salt.state.file](https://docs.saltproject.io/en/latest/ref/states/all/salt.states.file.html)-osiosta siihen löytyi vastaus, eli kansioille ja tiedostolle piti asettaa omistajaksi vagrant-käyttäjä. Kansioille asetin myös recurse-kohtaan userin, koska loin useamman kansion kerralla ja halusin kumpaankin omistajaksi vagrantin. 
Ajoin tilan paikallisesti useampaan kertaan vaiheita testaillessa. Tarkastin curlilla että localhost oli muuttunut. 

<img src='https://github.com/iines-j/palvelin-kurssi/assets/148907657/14319cd0-cd0e-4795-9743-dd7f4ecbb6e5' width=600>


## d) SSHouto
> Lisää uusi portti, jossa SSHd kuuntelee.

    Jos käytät Vagrantia, muista jättää portti 22/tcp auki - se on oma yhteytesi koneeseen. SSHd:n asetustiedostoon voi tehdä yksinkertaisesti kaksi "Port" riviä, molemmat portit avataan.
    Löydät oikean asetuksen katsomalla SSH:n asetustiedostoa
    Nyt tarvitaan service-watch, jotta demoni käynnistetään uudelleen, jos asetustiedosto muuttuu masterilla



## e) Vapaaehtoinen: Apache
> Asenna Apache tarjoilemaan weppisivua.
> Weppisivun tulee näkyä palvelimen etusivulla (localhost).
> HTML:n tulee olla jonkun käyttäjän kotihakemistossa, ja olla muokattavissa normaalin käyttäjän oikeuksin, ilman sudoa.



## f) Vapaaehtoinen: Caddy
> Asenna Caddy tarjoilemaan weppisivua.
> Weppisivun tulee näkyä palvelimen etusivulla (localhost).
> HTML:n tulee olla jonkun käyttäjän kotihakemistossa, ja olla muokattavissa normaalin käyttäjän oikeuksin, ilman sudoa.


## g) Vapaaehtoinen: Nginx
> Asenna Nginx (lausutaan engine-X) tarjoilemaan weppisivua.
> Weppisivun tulee näkyä palvelimen etusivulla (localhost).
> HTML:n tulee olla jonkun käyttäjän kotihakemistossa, ja olla muokattavissa normaalin käyttäjän oikeuksin, ilman sudoa.

____
## Lähteet
- Tero Karvinen, 2024. Infra as Code - Palvelinten hallinta 2024. [Linkki.](https://terokarvinen.com/2024/configuration-management-2024-spring/) Luettu 20.4.2024.
- Tero Karvinen, 2023. Salt Vagrant - automatically provision one master and two slaves. [Linkki.](https://terokarvinen.com/2023/salt-vagrant/#infra-as-code---your-wishes-as-a-text-file) Luettu 20.4.2024.
- Salt Project. Salt overview. [Linkki.](https://docs.saltproject.io/salt/user-guide/en/latest/topics/overview.html#rules-of-yaml) Luettu 20.4.2024.
- Tero Karvinen, 2018. Pkg-File-Service – Control Daemons with Salt – Change SSH Server Port. [Linkki.](https://terokarvinen.com/2018/04/03/pkg-file-service-control-daemons-with-salt-change-ssh-server-port/?fromSearch=karvinen%20salt%20ssh) Luettu 20.4.2024.
- Salt Project. salt.states.pkg. [Linkki.](https://docs.saltproject.io/en/latest/ref/states/all/salt.states.pkg.html) Luettu 20.4.2024.
- Salt Project. salt.states.service. [Linkki.](https://docs.saltproject.io/en/latest/ref/states/all/salt.states.service.html) Luettu 20.4.2024.
- Salt Project. salt.states.file. [Linkki.](https://docs.saltproject.io/en/latest/ref/states/all/salt.states.file.html) Luettu 20.4.2024.
